<!DOCTYPE html>
<html lang=zh-CN>
  <head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="sogou_site_verification" content="rZCOURJedr">
  <meta name="baidu-site-verification" content="MHKqWQPYmp">
  <meta name="google-site-verification" content="7_5x-cd73n3XFQt0nK2XOiOASPW_RyZRDBEXcUiB0nY">
  <meta name="msvalidate.01" content="85212EBB223945AE5D88E54E3D5B5E64">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content>
  <meta name="keywords" content="ArcGIS,Leaflet,GeoServer,PostGIS,Python">
  
    <link rel="icon" href="/favicon.ico">
  
    
  <title>蓝牙Beacon室内定位全栈 | Hello Map</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/lib/jquery.fancybox.min.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>
  <header>
  <div class="header-container">
    <a class='logo' href="/">
      <span>Hello Map</span>
    </a>
    <ul class="right-header">
      
        <li class="nav-item">
          
            <a href="/" class="item-link">首页</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/about" class="item-link">关于</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/archives" class="item-link">归档</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/tags" class="item-link">标签</a>
          
        </li>
      
    </ul>
  </div>
</header>

  <main id='post'>
  <div class="content">
    <article>
        <section class="content markdown-body">
          <h1>蓝牙Beacon室内定位全栈</h1>
          <div class='post-meta'>
            <i class="fa fa-calendar" aria-hidden="true"></i> <time>2021年11月25日</time>
            
            
              | 
                  <i class="fa fa-tags" aria-hidden="true"></i>
                
               
  <a href="/tags/#导航" class='tag'>导航</a>

  <a href="/tags/#室内定位" class='tag'>室内定位</a>

  <a href="/tags/#Beacon" class='tag'>Beacon</a>


            
          </div>
          <p>GPS是成熟很久的技术，智能手机发展起来之后GPS成了手机手机的必备模块之一，但室内没有GPS信号，使得室内定位到目前为止都是难点之一。但理论上技术倒真没难到什么程度，只要有可以在室内用的定位信号基站，手机端可以接收并解析就行了。但也有如下难点：</p>
<ul>
<li>室内距离短，电磁波传播速度太快，模仿GPS通过数据发送时间和接收时间的时间差来计算接收端与发送端之间的距离就不靠谱。</li>
<li>室内遮挡多会导致信号衰减，因此通过信号衰减量来计算接收端与发送端之间的距离也不靠谱。</li>
<li>便宜和兼容性，得方便移动设备用，高端的扫地机器人可以通过激光雷达给房间建模然后规划路线，这定位是精准了，但是让每个手机自带激光雷达明显不现实。超声波也可以用来定位，但这东西放手机上就没啥用。</li>
</ul>
<p>Beacon的出现，这一切迎刃而解。</p>
<p>2012年，蓝牙4.0标准发布，低功耗蓝牙(Bluetooth Low Energy,BLE)技术成熟，一刻纽扣电池就可以让一个BLE设备工作很久。2013年苹果WWDC发布的设备支持iBeacon，标志着Beacon协议开始广泛用于个人移动设备。Beacon设备会每隔一定的时间广播一个数据包（BeaconName+UUID+Major+Minor+TX power）到周围，当手机接近时扫描到该设备，就能接收到其广播的数据包。Beacon设备用于室内定位有以下优势：</p>
<ul>
<li>几乎所有的手机都有蓝牙模块，不用担心兼容性问题。</li>
<li>价格便宜，一百个Beacon设备也比不上一个激光雷达，可以大批量部署。</li>
<li>传播距离近，遮挡等干扰少，信号衰减可以作为计算距离的参考。</li>
</ul>
<p>接下来是我研究Beacon室内定位的整个流程，可能带有非常明显的小作坊的色彩，也还有不少部分需要完善，但也算是五脏齐全了。</p>
<h2 id="数据生产"><a href="#数据生产" class="headerlink" title="数据生产"></a>数据生产</h2><p>室内定位首先要有室内地图，或者室内的三维模型，理论上室内定位不需要理真实坐标，可以完全以建模或者室内地图的坐标系来，只要保证Beacon信标的坐标系与室内地图的坐标系一致即可。但这么做明显不利于后期可能存在的室内定位与室外定位相结合，也不利于标准化的生产和部署。所以我这里与真是坐标系相结合，建筑、楼层、信标的位置都直接保存成经纬度，根据我在博文《三维GIS建模不要用墨卡托投影》中的说明，我在三维建模时采用了CGS2000高斯-克吕格三度带投影坐标系。</p>
<p>在这里我首先说一下我的数据库设计，首先我假设了有多个需要室内定位的项目，每个项目可能有好几栋楼，每栋楼有若干层，每层部署若干Beacon信标（理论上8到10米，离地2米高左右的楼顶、墙壁或柱子上部署），楼栋和楼层都有自己的模型，数据库每张表的关系也这么设计。</p>
<p>然后就是我生产的目标数据是什么了，这跟我的技术路线有关，至少生产出来的三维模型能在我的管理后台和手机上用。技术选型有以下的考量：</p>
<ul>
<li>如果有多个项目，我的后台管理系统得统一管理，最好把多个项目的模型同时显示，方便查看。</li>
<li>移动端最好跨平台，支持安卓和苹果，方便更广泛的使用。</li>
</ul>
<p>管理后台其实很好确定了，要显示那么大范围的三维，<a href="https://www.cesium.com/" target="_blank" rel="noopener">Cesium</a>基本上是唯一的选择。移动客户端就比较难受，想到跨平台三维，首先就能想到Unity这类游戏开发的，肯定是可以跨平台的。但是很遗憾，Unity不支持在线的三维模型资源，都得先下载到本地才能加载。最后移动端选择了直接做成WebApp然后通过Cordova打包，所以实际上移动端也能直接用Cesium的，但移动端通常只显示一栋楼或者一个项目的模型就行，还得显示个地球，有点多余，因此采用了微软的基于WebGL的三维引擎<a href="https://www.babylonjs.com/" target="_blank" rel="noopener">babylonjs</a>。</p>
<p>技术路线一确定，数据生产的目标也就确定了，生产成Cesium和babylonjs都可以很方便使用的gltf模型。</p>
<h3 id="楼栋白模"><a href="#楼栋白模" class="headerlink" title="楼栋白模"></a>楼栋白模</h3><p>这不是一个有真实需求的项目，因此我一丁点数据都没有，所有的数据都得自力更生，首先是楼栋白模。楼栋白模还是很方便制作的。</p>
<ol>
<li>我从OpenStreetMap上下载了我需要做的楼栋的数据，下载下来的是WGS84地理坐标系OSM格式的数据。</li>
<li>用<a href="https://www.qgis.org/en/site/" target="_blank" rel="noopener">QGIS</a>软件加载OSM数据，并把里面的房屋面提取出来成shp，假设名字叫fwm.shp，然后将数据重投影成CGS2000高斯克-吕格3度带投影坐标系，根据数据所在的经纬度来确定带号fwm_projection.shp。同时地理坐标系的数据也要保留着（因为WGS84地理坐标系和CGS2000地理坐标系非常相似，因此保留WGS84地理坐标系的数据也能当CGS2000地理坐标系的数据用）。</li>
<li>将fwm_projection.shp用QGIS打开，要素另存为AutoCAD DXF文件fwm_projection.dxf。</li>
<li>用AutoCAD打开fwm_projection.dxf文件，使用三维工具根据楼层的高度拉升成三维数据，保存成fwm_projection.dwg，这时候已经是一个三维模型了，接下来是将他转换成gltf（这里用glb，免得一个模型是多个文件）。</li>
<li>如果有FME2020以上的版本，可以直接将fwm_projection.dwg转换成fwm_projection.glb，如果没有也可以用Sketchup Pro导入dwg，然后导出成fbx或者obj模型，导出的时候注意勾选<strong>导出全部平面为三角</strong>形和<strong>切换YZ坐标</strong>，导入和导出时都要<strong>将单位设置成米</strong>，最后用Windows 10自带的3D查看器打开并保存成glb即可。我在博文《三维GIS建模不要用墨卡托投影》中有提到Cesium的三维笛卡尔坐标系跟建模软件的坐标系不一致的问题，因此这里的模型旋转问题需要处理，要就在建模的时候处理，要就在客户端去处理，反正就是要旋转一下。</li>
<li>接下来就是坐标问题了，这么创建的模型的坐标原点，对应的是平面图形的左下角，如果是比较规则的房屋面倒还好，特别是左下角恰好是房屋定点就比较方便，下面说通用的情况。在QGIS里面打开之前地理坐标系的房屋面，也就是fwm.shp，使用选择工具选中建模的那个房屋面，在工具箱中打开矢量地理对象&gt;最小边界矢量图像，输入图层选择fwm.shp，几何图像类型选择边界框，勾选上<strong>仅选中的要素</strong>，就可以生成房屋面的边界举行，那这个矩形的左下角就对应了模型的坐标原点了，将地图放大到最大，鼠标放在矩形的左下角，鼠标所在位置的经纬度就是我们要记录下来的位置了。保存起来，以后房屋的模型就以这个坐标加载到场景。</li>
</ol>
<h3 id="楼层模型"><a href="#楼层模型" class="headerlink" title="楼层模型"></a>楼层模型</h3><p>楼层模型的生产与白模的生产大体上类似，不过因为我没有原数据，数据获取有点麻烦。</p>
<ul>
<li>首先我在网上搜了一下我要做的这栋楼的户型图，运气好，搜到了。</li>
<li>然后我将户型图导入上面的fwm_projection.dxf，调整大小，方向和位置，让他能跟房屋面的外廓线匹配起来，之后再照着户型图用CAD画了一遍，就能保证位置和户型大体上差不多了。</li>
<li>再之后就跟做白模差不多了，不过做楼层模型可以做个材质，这在Sketchup里很方便。还有一点要注意，楼层的插入经纬度跟楼栋不一定是一样的，比如有的楼下面10层是商场，上面40层是办公楼，或者有AB栋连在一起我只做B栋的楼层模型但是房屋白模是AB栋一体的。</li>
</ul>
<h2 id="管理后台展示模型"><a href="#管理后台展示模型" class="headerlink" title="管理后台展示模型"></a>管理后台展示模型</h2><p>其实这部分倒是简单了，如上面所说，后台管理用的Cesium，总的来说就是选中项目之后定位到项目的几栋房屋所在的位置，点选中楼栋之后楼栋半透明，显示楼层列表，并默认选择第一楼层，选择哪个楼层就显示哪个楼层的模型。核心代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/************************</span></span><br><span class="line"><span class="comment"> * 初始化事件</span></span><br><span class="line"><span class="comment"> ************************/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initEvent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">'#project_select'</span>).on(<span class="string">'change'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> project = _projects[$(<span class="string">'#project_select'</span>).val()]</span><br><span class="line">        <span class="keyword">const</span> rectangle = Cesium.Rectangle.fromDegrees(project.minLongitude, project.minLatitude, project.maxLongitude, project.maxLatitude);</span><br><span class="line">        Cesium.Camera.DEFAULT_VIEW_RECTANGLE = rectangle;</span><br><span class="line">        _viewer.camera.flyTo(&#123;</span><br><span class="line">            destination: rectangle</span><br><span class="line">        &#125;);</span><br><span class="line">        showBuilding(project);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> handler = <span class="keyword">new</span> Cesium.ScreenSpaceEventHandler(_viewer.scene.canvas);</span><br><span class="line">    handler.setInputAction(<span class="function"><span class="keyword">function</span> (<span class="params">movement</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> pick = _viewer.scene.pick(movement.position);</span><br><span class="line">        <span class="keyword">if</span> (Cesium.defined(pick) &amp;&amp; Cesium.defined(pick.id)) &#123;</span><br><span class="line">            <span class="keyword">const</span> entity = pick.id;</span><br><span class="line">            <span class="keyword">if</span> (entity.id.startsWith(<span class="string">'building_'</span>)) &#123;</span><br><span class="line">                entity.model.color = Cesium.Color.WHITE.withAlpha(<span class="number">0.3</span>);</span><br><span class="line">                <span class="keyword">const</span> buildingId = entity.id.replace(<span class="string">'building_'</span>, <span class="string">''</span>);</span><br><span class="line">                showFloors(buildingId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            clearFloors();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;, Cesium.ScreenSpaceEventType.LEFT_CLICK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/************************</span></span><br><span class="line"><span class="comment"> * 加载所有项目数据</span></span><br><span class="line"><span class="comment"> ************************/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadProjects</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">'#project_select'</span>).empty();</span><br><span class="line">    $.post(<span class="string">`<span class="subst">$&#123;Config.BASE_URL&#125;</span>/api/project/list-all`</span>, <span class="built_in">JSON</span>.stringify(&#123;&#125;), <span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (response.succeeded) &#123;</span><br><span class="line">            _projects = response.data;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; index &lt; _projects.length; index++) &#123;</span><br><span class="line">                <span class="keyword">const</span> project = _projects[index];</span><br><span class="line">                $(<span class="string">'#project_select'</span>).append(<span class="string">`&lt;option value=<span class="subst">$&#123;index&#125;</span>&gt;<span class="subst">$&#123;project.name&#125;</span>&lt;/option&gt;`</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (_projects.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> project = _projects[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">const</span> rectangle = Cesium.Rectangle.fromDegrees(project.minLongitude, project.minLatitude, project.maxLongitude, project.maxLatitude);</span><br><span class="line">                Cesium.Camera.DEFAULT_VIEW_RECTANGLE = rectangle;</span><br><span class="line">                _viewer.camera.flyTo(&#123;</span><br><span class="line">                    destination: rectangle</span><br><span class="line">                &#125;);</span><br><span class="line">                showBuildings(project);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 展示一个项目所有的建筑物</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>project </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showBuildings</span>(<span class="params">project</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> buildings = project.buildings;</span><br><span class="line">    <span class="keyword">const</span> midLat = (project.minLatitude + project.maxLatitude) / <span class="number">2</span>;</span><br><span class="line">    buildings.forEach(<span class="function"><span class="params">building</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> entity = _viewer.entities.add(&#123;</span><br><span class="line">            name: building.name,</span><br><span class="line">            id: <span class="string">'building_'</span> + building.id,</span><br><span class="line">            position: <span class="keyword">new</span> Cesium.Cartesian3.fromDegrees(building.x, building.y, building.height),</span><br><span class="line">            model: &#123;</span><br><span class="line">                uri: <span class="string">`<span class="subst">$&#123;Config.BASE_URL&#125;</span>/api/building/download-model/<span class="subst">$&#123;building.model&#125;</span>`</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 展示一个建筑物的楼层</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>buildingId </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showFloors</span>(<span class="params">buildingId</span>) </span>&#123;</span><br><span class="line">    $(<span class="string">'#lg_floor'</span>).empty();</span><br><span class="line">    $.<span class="keyword">get</span>(`$&#123;Config.BASE_URL&#125;/api/building/$&#123;buildingId&#125;<span class="string">`, function (response) &#123;</span></span><br><span class="line"><span class="string">        if (response.succeeded) &#123;</span></span><br><span class="line"><span class="string">            _selectedBuilding = response.data;</span></span><br><span class="line"><span class="string">            for (let index = 0; index &lt; _selectedBuilding.floors.length; index++) &#123;</span></span><br><span class="line"><span class="string">                const floor = _selectedBuilding.floors[index];</span></span><br><span class="line"><span class="string">                $('#lg_floor').append(`</span>&lt;a href=<span class="string">"javascript: void(0);"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"list-group-item list-group-item-action"</span>&gt;$&#123;floor.name&#125;&lt;<span class="regexp">/a&gt;`);</span></span><br><span class="line"><span class="regexp">            &#125;</span></span><br><span class="line"><span class="regexp">            $('#lg_floor').fadeIn();</span></span><br><span class="line"><span class="regexp">            $('#lg_floor .list-group-item').on('click', function (e) &#123;</span></span><br><span class="line"><span class="regexp">                const index = $(e.target).index();</span></span><br><span class="line"><span class="regexp">                showFloor(index);</span></span><br><span class="line"><span class="regexp">            &#125;)</span></span><br><span class="line"><span class="regexp">            if (_selectedBuilding.floors.length &gt; 0) &#123;</span></span><br><span class="line"><span class="regexp">                showFloor(0)</span></span><br><span class="line"><span class="regexp">            &#125;</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">    &#125;)</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span>**</span><br><span class="line"> * 展示单个楼层</span><br><span class="line"> * @param &#123;*&#125; index </span><br><span class="line"> *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">function showFloor(index) &#123;</span></span><br><span class="line"><span class="regexp">    _viewer.entities.values.forEach(entity =&gt; &#123;</span></span><br><span class="line"><span class="regexp">        if (entity.id.startsWith('floor_')) &#123;</span></span><br><span class="line"><span class="regexp">            _viewer.entities.remove(entity);</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">    &#125;);</span></span><br><span class="line"><span class="regexp">    $('#lg_floor .list-group-item').removeClass('active');</span></span><br><span class="line"><span class="regexp">    $(`#lg_floor .list-group-item:nth-child($&#123;index + 1&#125;)`).addClass('active')</span></span><br><span class="line"><span class="regexp">    const floor = _selectedBuilding.floors[index];</span></span><br><span class="line"><span class="regexp">    var entity = _viewer.entities.add(&#123;</span></span><br><span class="line"><span class="regexp">        name: floor.name,</span></span><br><span class="line"><span class="regexp">        id: 'floor_' + floor.id,</span></span><br><span class="line"><span class="regexp">        position: new Cesium.Cartesian3.fromDegrees(floor.x, floor.y, floor.height),</span></span><br><span class="line"><span class="regexp">        model: &#123;</span></span><br><span class="line"><span class="regexp">            uri: `$&#123;Config.BASE_URL&#125;/</span>api/floor/download-model/$&#123;floor.model&#125;<span class="string">`,</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">    //展示信标基站</span></span><br><span class="line"><span class="string">    showStations(floor);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/**</span></span><br><span class="line"><span class="string"> * 清除建筑物图层</span></span><br><span class="line"><span class="string"> */</span></span><br><span class="line"><span class="string">function clearFloors() &#123;</span></span><br><span class="line"><span class="string">    $('#lg_floor').fadeOut();</span></span><br><span class="line"><span class="string">    _viewer.entities.values.forEach(entity =&gt; &#123;</span></span><br><span class="line"><span class="string">        if (entity.id.startsWith('building_')) &#123;</span></span><br><span class="line"><span class="string">            entity.model.color = Cesium.Color.WHITE;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        else if (entity.id.startsWith('floor_')) &#123;</span></span><br><span class="line"><span class="string">            _viewer.entities.remove(entity);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="移动端展示模型"><a href="#移动端展示模型" class="headerlink" title="移动端展示模型"></a>移动端展示模型</h2><p>前面有说移动端展使用Cordova打包WebApp的方式，这中间的细节之后再说，所以实际上移动端的展示也是用的网页，这里用了babylonjs。这里也会有几个问题：</p>
<ul>
<li>我们保存的房屋模型、楼层模型、信标坐标都是经纬度，但是在做距离计算的时候一般是不用经纬度来算球面距离的。而且我们的模型是用高斯-克吕格投影坐标系做的，距离单位也是米，以经纬度为坐标插入笛卡尔坐标系的场景是乱套了。Cesium能直接以经纬度插入是因为Cesium本来就构建了一个地球，因此首先需要将经纬度转换成高斯克吕格投影坐标。</li>
<li>转过过来的高斯-克吕格投影坐标系是一个非常大的数值，当然一直用这么大的数值也没啥问题，但总是不利于调试对比，因此我们可以以一个项目里所有房屋的最小插入点当做原点(0,0)，给插入点的坐标都变成比较小的数值。</li>
<li>第二个问题，上面有提到，我在其他博文里说过不同软件不同库笛卡尔坐标系不同的问题，babylonjs会自己做一定的处理，比如他在加载gltf的时候会默认沿Y轴旋转180°，会给Z坐标乘一个-1，以适配大多数的三维建模软件，具体看<a href="https://doc.babylonjs.com/extensions/Exporters/Blender_to_glTF" target="_blank" rel="noopener">文档</a>，但是出来到底符不符合，就得具体看了。</li>
</ul>
<p>然后逻辑其实跟管理后台差不多了，下面主要贴高斯-克吕格投影坐标系和经纬度互转的代码。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>gcs_wkid 地理坐标系wkid</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>centerLongitude 中央经线经度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns </span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> Gauss_Krueger_Projection = <span class="function"><span class="keyword">function</span>(<span class="params">gcs_wkid,centerLongitude</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> a ;<span class="comment">//'椭球体长半轴</span></span><br><span class="line">    <span class="keyword">var</span> b;<span class="comment">// '椭球体短半轴</span></span><br><span class="line">    <span class="keyword">var</span> k0  = <span class="number">1</span>;<span class="comment">//'比例因子</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (gcs_wkid) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4214</span>:</span><br><span class="line">            <span class="comment">//GCS_Beijing_1954</span></span><br><span class="line">            a = <span class="number">6378245</span>;</span><br><span class="line">            b = <span class="number">6356863.0188</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4610</span>:</span><br><span class="line">            <span class="comment">//GCS_Xian_1980</span></span><br><span class="line">            a = <span class="number">6378140</span>;</span><br><span class="line">            b = <span class="number">6356755.2882</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4490</span>:</span><br><span class="line">            <span class="comment">//GCS_China_Geodetic_Coordinate_System_2000</span></span><br><span class="line">            a = <span class="number">6378137.0</span>;</span><br><span class="line">            b = <span class="number">6356752.314140356</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4326</span>:</span><br><span class="line">            <span class="comment">//GCS_WGS_1984</span></span><br><span class="line">            a = <span class="number">6378137</span>;</span><br><span class="line">            b = <span class="number">6356752.3142</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> f = (a - b) / a;<span class="comment">//扁率</span></span><br><span class="line">    <span class="keyword">var</span> e = <span class="built_in">Math</span>.sqrt(<span class="number">2</span>*f - <span class="built_in">Math</span>.pow(f ,<span class="number">2</span>));<span class="comment">//第一偏心率</span></span><br><span class="line">    <span class="keyword">var</span> e1 = e / <span class="built_in">Math</span>.sqrt(<span class="number">1</span> - <span class="built_in">Math</span>.pow(e , <span class="number">2</span>));<span class="comment">//'第二偏心率</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 经纬度转平面坐标系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>lon </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>lat </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">LngLat2XY</span>(<span class="params">lng,lat</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> BR = lat * <span class="built_in">Math</span>.PI / <span class="number">180</span>;<span class="comment">//纬度弧长</span></span><br><span class="line">        <span class="keyword">var</span> lo = (lng - centerLongitude)*<span class="built_in">Math</span>.PI/<span class="number">180</span>; <span class="comment">//经差弧度</span></span><br><span class="line">        <span class="keyword">var</span> N = a / <span class="built_in">Math</span>.sqrt(<span class="number">1</span> - <span class="built_in">Math</span>.pow((e * <span class="built_in">Math</span>.sin(BR)) , <span class="number">2</span>)) <span class="comment">//卯酉圈曲率半径</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//求解参数s</span></span><br><span class="line">        <span class="keyword">var</span> C = <span class="built_in">Math</span>.pow(a , <span class="number">2</span>)/ b;</span><br><span class="line">        <span class="keyword">var</span> B0 = <span class="number">1</span> - <span class="number">3</span> * <span class="built_in">Math</span>.pow(e1 , <span class="number">2</span>) / <span class="number">4</span> + <span class="number">45</span> *<span class="built_in">Math</span>.pow( e1 ,<span class="number">4</span>) / <span class="number">64</span> - <span class="number">175</span> * <span class="built_in">Math</span>.pow(e1 , <span class="number">6</span>) / <span class="number">256</span> + <span class="number">11025</span> * <span class="built_in">Math</span>.pow(e1 , <span class="number">8</span> )/ <span class="number">16384</span>;</span><br><span class="line">        <span class="keyword">var</span> B2 = B0 - <span class="number">1</span></span><br><span class="line">        <span class="keyword">var</span> B4 = <span class="number">15</span> / <span class="number">32</span> * <span class="built_in">Math</span>.pow(e1 , <span class="number">4</span>) - <span class="number">175</span> / <span class="number">384</span> * <span class="built_in">Math</span>.pow(e1 , <span class="number">6</span> )+ <span class="number">3675</span> / <span class="number">8192</span> *<span class="built_in">Math</span>.pow( e1 , <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">var</span> B6 = <span class="number">0</span> - <span class="number">35</span> / <span class="number">96</span> *<span class="built_in">Math</span>.pow( e1 , <span class="number">6</span>) + <span class="number">735</span> / <span class="number">2048</span> * <span class="built_in">Math</span>.pow(e1 , <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">var</span> B8 = <span class="number">315</span> / <span class="number">1024</span> * <span class="built_in">Math</span>.pow(e1 , <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">var</span> s = C * (B0 * BR + <span class="built_in">Math</span>.sin(BR) * (B2 * <span class="built_in">Math</span>.cos(BR) + B4 * <span class="built_in">Math</span>.pow((<span class="built_in">Math</span>.cos(BR)) , <span class="number">3</span>) + B6 * <span class="built_in">Math</span>.pow((<span class="built_in">Math</span>.cos(BR)) , <span class="number">5</span> )+ B8 * <span class="built_in">Math</span>.pow((<span class="built_in">Math</span>.cos(BR)) , <span class="number">7</span>)))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> t = <span class="built_in">Math</span>.tan(BR);</span><br><span class="line">        <span class="keyword">var</span> g = e1 * <span class="built_in">Math</span>.cos(BR);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> XR= s + <span class="built_in">Math</span>.pow(lo , <span class="number">2</span>) / <span class="number">2</span> * N * <span class="built_in">Math</span>.sin(BR) * <span class="built_in">Math</span>.cos(BR) + <span class="built_in">Math</span>.pow(lo , <span class="number">4</span> )* N * <span class="built_in">Math</span>.sin(BR) * <span class="built_in">Math</span>.pow((<span class="built_in">Math</span>.cos(BR)) , <span class="number">3</span>) / <span class="number">24</span> * (<span class="number">5</span> -<span class="built_in">Math</span>.pow( t , <span class="number">2</span> )+ <span class="number">9</span> * <span class="built_in">Math</span>.pow(g , <span class="number">2</span>) + <span class="number">4</span> *<span class="built_in">Math</span>.pow( g , <span class="number">4</span>)) + <span class="built_in">Math</span>.pow(lo , <span class="number">6</span>) * N * <span class="built_in">Math</span>.sin(BR) * <span class="built_in">Math</span>.pow((<span class="built_in">Math</span>.cos(BR)) , <span class="number">5</span>) * (<span class="number">61</span> - <span class="number">58</span> *<span class="built_in">Math</span>.pow( t , <span class="number">2</span>) + <span class="built_in">Math</span>.pow(t , <span class="number">4</span>)) / <span class="number">720</span>;</span><br><span class="line">        <span class="keyword">var</span> YR= lo * N * <span class="built_in">Math</span>.cos(BR) + <span class="built_in">Math</span>.pow(lo , <span class="number">3</span> )* N / <span class="number">6</span> *<span class="built_in">Math</span>.pow( (<span class="built_in">Math</span>.cos(BR)) , <span class="number">3</span>) * (<span class="number">1</span> - <span class="built_in">Math</span>.pow(t , <span class="number">2</span>) + <span class="built_in">Math</span>.pow(g , <span class="number">2</span>)) + <span class="built_in">Math</span>.pow(lo , <span class="number">5</span>) * N / <span class="number">120</span> * <span class="built_in">Math</span>.pow((<span class="built_in">Math</span>.cos(BR)) , <span class="number">5</span>) * (<span class="number">5</span> - <span class="number">18</span> * <span class="built_in">Math</span>.pow(t , <span class="number">2</span>) + <span class="built_in">Math</span>.pow(t , <span class="number">4</span>) + <span class="number">14</span> * <span class="built_in">Math</span>.pow(g , <span class="number">2</span>) - <span class="number">58</span> * <span class="built_in">Math</span>.pow(g , <span class="number">2</span>) * <span class="built_in">Math</span>.pow(t , <span class="number">2</span>));</span><br><span class="line">        <span class="keyword">var</span> x=YR;</span><br><span class="line">        <span class="keyword">var</span> y=XR;</span><br><span class="line">        <span class="keyword">return</span> [x,y];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 平面坐标系转经纬度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>x </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>y </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">XY2LngLat</span>(<span class="params">x,y</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> El1 = (<span class="number">1</span> - <span class="built_in">Math</span>.sqrt(<span class="number">1</span> - <span class="built_in">Math</span>.pow(e , <span class="number">2</span>))) / (<span class="number">1</span> + <span class="built_in">Math</span>.sqrt(<span class="number">1</span> -<span class="built_in">Math</span>.pow( e , <span class="number">2</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> Mf = y/ k0 ;<span class="comment">//真实坐标值</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> Q = Mf / (a * (<span class="number">1</span> - <span class="built_in">Math</span>.pow(e , <span class="number">2</span>) / <span class="number">4</span> - <span class="number">3</span> * <span class="built_in">Math</span>.pow(e , <span class="number">4</span>) / <span class="number">64</span> - <span class="number">5</span> *<span class="built_in">Math</span>.pow( e , <span class="number">6</span>) / <span class="number">256</span>));<span class="comment">//角度</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> Bf = Q + (<span class="number">3</span> * El1 / <span class="number">2</span> - <span class="number">27</span> *<span class="built_in">Math</span>.pow( El1 , <span class="number">3</span>) / <span class="number">32</span>) * <span class="built_in">Math</span>.sin(<span class="number">2</span> * Q) + (<span class="number">21</span> *<span class="built_in">Math</span>.pow( El1 , <span class="number">2</span>) / <span class="number">16</span> - <span class="number">55</span> *<span class="built_in">Math</span>.pow( El1 , <span class="number">4</span> )/ <span class="number">32</span>) * <span class="built_in">Math</span>.sin(<span class="number">4</span> * Q) + (<span class="number">151</span> *<span class="built_in">Math</span>.pow( El1 , <span class="number">3</span> )/ <span class="number">96</span>) * <span class="built_in">Math</span>.sin(<span class="number">6</span> * Q) + <span class="number">1097</span> / <span class="number">512</span> * <span class="built_in">Math</span>.pow(El1 , <span class="number">4</span>) * <span class="built_in">Math</span>.sin(<span class="number">8</span> * Q);</span><br><span class="line">        <span class="keyword">var</span> Rf = a * (<span class="number">1</span> -<span class="built_in">Math</span>.pow( e , <span class="number">2</span>)) / <span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow((<span class="number">1</span> - <span class="built_in">Math</span>.pow((e * <span class="built_in">Math</span>.sin(Bf)) ,<span class="number">2</span>)) , <span class="number">3</span>));</span><br><span class="line">        <span class="keyword">var</span> Nf = a / <span class="built_in">Math</span>.sqrt(<span class="number">1</span> - <span class="built_in">Math</span>.pow((e * <span class="built_in">Math</span>.sin(Bf)) , <span class="number">2</span>));<span class="comment">//卯酉圈曲率半径</span></span><br><span class="line">        <span class="keyword">var</span> Tf = <span class="built_in">Math</span>.pow((<span class="built_in">Math</span>.tan(Bf)) , <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">var</span> D =x/ (k0 * Nf);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> Cf =<span class="built_in">Math</span>.pow( e1 , <span class="number">2</span>) * <span class="built_in">Math</span>.pow((<span class="built_in">Math</span>.cos(Bf)) , <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> B = Bf - Nf * <span class="built_in">Math</span>.tan(Bf) / Rf * (<span class="built_in">Math</span>.pow(D , <span class="number">2</span>) / <span class="number">2</span> - (<span class="number">5</span> + <span class="number">3</span> * Tf + <span class="number">10</span> * Cf - <span class="number">9</span> * Tf * Cf - <span class="number">4</span> *<span class="built_in">Math</span>.pow( Cf , <span class="number">2</span>) - <span class="number">9</span> * <span class="built_in">Math</span>.pow(e1 , <span class="number">2</span>)) *<span class="built_in">Math</span>.pow( D , <span class="number">4</span>) / <span class="number">24</span> + (<span class="number">61</span> + <span class="number">90</span> * Tf + <span class="number">45</span> * <span class="built_in">Math</span>.pow(Tf , <span class="number">2</span>) - <span class="number">256</span> * <span class="built_in">Math</span>.pow(e1 , <span class="number">2</span>) - <span class="number">3</span> * <span class="built_in">Math</span>.pow(Cf , <span class="number">2</span>)) *<span class="built_in">Math</span>.pow( D , <span class="number">6</span>) / <span class="number">720</span>);</span><br><span class="line">        <span class="keyword">var</span> L = centerLongitude*<span class="built_in">Math</span>.PI/<span class="number">180</span> + <span class="number">1</span> / <span class="built_in">Math</span>.cos(Bf) * (D - (<span class="number">1</span> + <span class="number">2</span> * Tf + Cf) *<span class="built_in">Math</span>.pow( D , <span class="number">3</span>) / <span class="number">6</span> + (<span class="number">5</span> - <span class="number">2</span> * Cf + <span class="number">28</span> * Tf - <span class="number">3</span> *<span class="built_in">Math</span>.pow( Cf , <span class="number">2</span>) + <span class="number">8</span> * <span class="built_in">Math</span>.pow(e1 , <span class="number">2</span>) + <span class="number">24</span> * <span class="built_in">Math</span>.pow(Tf , <span class="number">2</span>)) * <span class="built_in">Math</span>.pow(D , <span class="number">5</span> )/ <span class="number">120</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> Bangle = B * <span class="number">180</span> / <span class="built_in">Math</span>.PI;</span><br><span class="line">        <span class="keyword">var</span> Langle = L * <span class="number">180</span> / <span class="built_in">Math</span>.PI;      </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [Langle,Bangle];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>&#123;</span><br><span class="line">        LngLat2XY:LngLat2XY,</span><br><span class="line">        XY2LngLat:XY2LngLat</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Beacon设备的组织"><a href="#Beacon设备的组织" class="headerlink" title="Beacon设备的组织"></a>Beacon设备的组织</h2><p>上面有提到Beacon会周期性的向外界广播格式为BeaconName+UUID+Major+Minor+TX power的数据包，这些都是可以设置的。当然除了这些广播的数据，发送功率、时间间隔啥的也都是能设置的，我们这里主要说UUID，Major和Minor。</p>
<p>UUID是形式FDA50693-A4E2-4FB1-AFCF-C6EB07647824的一串字符串，占用16字节，通常同一批设备出厂的UUID会是一样的，我这里给他设置成了不同，前20位我设置成了一样的，标识这是我家的设备，移动端读的时候使用这一段关键字，也就能保证回来的只有我家设备的数据。最后12位设置成不同，成为设备的唯一码。</p>
<p>Major一般叫主值，占用两个字节，我这里每个字节存了不同的值，第一个字节存了项目标识，第二个字节存了楼栋标识。</p>
<p>Minor一般叫辅值，占用两个字节，跟主值一样我也设置了不同值，第一个字节存了楼层号，第二个字节存了信标标识。</p>
<p>我使用的是一个叫nRF Connect的安卓APP设置的。</p>
<h2 id="Beacon数据获取（Android）"><a href="#Beacon数据获取（Android）" class="headerlink" title="Beacon数据获取（Android）"></a>Beacon数据获取（Android）</h2><p>目前只做了安卓端。安卓获取Beacon数据使用了<a href="https://github.com/AltBeacon/android-beacon-library" target="_blank" rel="noopener">Android Beacon Library</a>。我写了一个BeaconService的服务，代码如下，其中Rssi代表信号强度，也就是定位要用的数据：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.zxhm.plugin.beacon;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Service;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.IBinder;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.annotation.Nullable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.altbeacon.beacon.Beacon;</span><br><span class="line"><span class="keyword">import</span> org.altbeacon.beacon.BeaconManager;</span><br><span class="line"><span class="keyword">import</span> org.altbeacon.beacon.BeaconParser;</span><br><span class="line"><span class="keyword">import</span> org.altbeacon.beacon.MonitorNotifier;</span><br><span class="line"><span class="keyword">import</span> org.altbeacon.beacon.RangeNotifier;</span><br><span class="line"><span class="keyword">import</span> org.altbeacon.beacon.Region;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeaconService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"BeaconService"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_FOREGROUND_SCAN_PERIOD = <span class="number">1000L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_FOREGROUND_BETWEEN_SCAN_PERIOD = <span class="number">1000L</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String IBEACON_FORMAT = <span class="string">"m:2-3=0215,i:4-19,i:20-21,i:22-23,p:24-24"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> BeaconManager beaconManager;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Collection&lt;BeaconDto&gt; beaconList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Region filterRegion = <span class="keyword">new</span> Region(<span class="string">"FDA50693-A4E2-4FB1"</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (beaconManager == <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            beaconManager = BeaconManager.getInstanceForApplication(<span class="keyword">this</span>);</span><br><span class="line">            beaconManager.setForegroundBetweenScanPeriod(DEFAULT_FOREGROUND_BETWEEN_SCAN_PERIOD);</span><br><span class="line">            beaconManager.setForegroundScanPeriod(DEFAULT_FOREGROUND_SCAN_PERIOD);</span><br><span class="line">            beaconManager.getBeaconParsers().add(<span class="keyword">new</span> BeaconParser().setBeaconLayout(IBEACON_FORMAT));</span><br><span class="line">        &#125;</span><br><span class="line">        beaconManager.addRangeNotifier(rangeNotifier);</span><br><span class="line">        beaconManager.startRangingBeacons(filterRegion);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        beaconManager.stopRangingBeacons(filterRegion);</span><br><span class="line">        beaconManager.removeAllRangeNotifiers();</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    RangeNotifier rangeNotifier = <span class="keyword">new</span> RangeNotifier() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">didRangeBeaconsInRegion</span><span class="params">(Collection&lt;Beacon&gt; beacons, Region region)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (beacons.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                beaconList.clear();</span><br><span class="line">                Log.d(TAG, <span class="string">"didRangeBeaconsInRegion called with beacon count:  "</span>+beacons.size());</span><br><span class="line">                <span class="keyword">for</span> (Beacon beacon: beacons) &#123;</span><br><span class="line">                    BeaconDto beaconDto = <span class="keyword">new</span> BeaconDto();</span><br><span class="line">                    beaconDto.setName(beacon.getBluetoothName());</span><br><span class="line">                    beaconDto.setUuid(beacon.getIdentifier(<span class="number">0</span>).toUuid().toString());</span><br><span class="line">                    beaconDto.setMac(beacon.getBluetoothAddress());</span><br><span class="line">                    beaconDto.setRssi(beacon.getRssi());</span><br><span class="line">                    beaconDto.setAvgRssi(beacon.getRunningAverageRssi());</span><br><span class="line">                    beaconDto.setMajor(beacon.getIdentifier(<span class="number">1</span>).toByteArray());</span><br><span class="line">                    beaconDto.setMinor(beacon.getIdentifier(<span class="number">2</span>).toByteArray());</span><br><span class="line">                    beaconList.add(beaconDto);</span><br><span class="line">                &#125;</span><br><span class="line">                Beacon firstBeacon = beacons.iterator().next();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>filterRegion实例化用到的字符串就是UUID前面一段不变的部分，最后数据保存成一个BeaconDto列表，方便其他地方使用。</p>
<p>这里需要注意权限问题和硬件使用问题，需要在AndroidManifest.xml文件mainfet节点下加入以下权限，如果是Android 6以后的设备还需要在代码中动态申请定位权限。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-feature</span> <span class="attr">android:name</span>=<span class="string">"android.hardware.bluetooth"</span> <span class="attr">android:required</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-feature</span> <span class="attr">android:name</span>=<span class="string">"android.hardware.bluetooth_le"</span>  <span class="attr">android:required</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.FOREGROUND_SERVICE"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.ACCESS_FINE_LOCATION"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.ACCESS_COARSE_LOCATION"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.ACCESS_BACKGROUND_LOCATION"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.BLUETOOTH"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.BLUETOOTH_ADMIN"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="WebApp获取Beacon数据"><a href="#WebApp获取Beacon数据" class="headerlink" title="WebApp获取Beacon数据"></a>WebApp获取Beacon数据</h2><p>本来有上面的内容，手机APP就已经获取Beacon数据了，但是我用了Cordova，实际上也就是用的一个WebView运行的网页程序，是没法直接获取硬件数据的，因此Cordova有了插件系统，用于原生和WebApp之间交互。其实Cordova的插件已经很丰富了，但是很可惜没有Beacon的，所以我自己写了一个。</p>
<p>怎么自定义和使用Cordova的插件这里就不说了，网上一搜就很多。我做的插件主要有三个功能，第一个是启用上面定义的获取数据的服务，第二个是停止服务，第三个是获取数据。代码如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.zxhm.plugin.beacon;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.AlertDialog;</span><br><span class="line"><span class="keyword">import</span> android.content.DialogInterface;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.altbeacon.beacon.BeaconConsumer;</span><br><span class="line"><span class="keyword">import</span> org.altbeacon.beacon.BeaconManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.cordova.CordovaPlugin;</span><br><span class="line"><span class="keyword">import</span> org.apache.cordova.CallbackContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.json.JSONArray;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONException;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This class echoes a string called from JavaScript.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Beacon</span> <span class="keyword">extends</span> <span class="title">CordovaPlugin</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"BeaconPlugin"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">execute</span><span class="params">(String action, JSONArray args, CallbackContext callbackContext)</span> <span class="keyword">throws</span> JSONException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (action.equals(<span class="string">"toast"</span>)) &#123;</span><br><span class="line">            String message = args.getString(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">this</span>.toast(message, callbackContext);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (action.equals(<span class="string">"getBeacons"</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.getBeacons(callbackContext);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (action.equals(<span class="string">"startService"</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.startService(callbackContext);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (action.equals(<span class="string">"stopService"</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.stopService(callbackContext);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启服务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> callbackContext</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startService</span><span class="params">(CallbackContext callbackContext)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (verifyBluetooth())</span><br><span class="line">        &#123;</span><br><span class="line">            Intent intent = <span class="keyword">new</span> Intent(cordova.getContext(), BeaconService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            cordova.getActivity().startService(intent);</span><br><span class="line">            callbackContext.success();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            callbackContext.error(<span class="string">"低功耗蓝牙不可用"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 停止服务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> callbackContext</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopService</span><span class="params">(CallbackContext callbackContext)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(cordova.getContext(), BeaconService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        cordova.getActivity().stopService(intent);</span><br><span class="line">        callbackContext.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取Beacon设备</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> callbackContext</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getBeacons</span><span class="params">(CallbackContext callbackContext)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JSONArray value = <span class="keyword">new</span> JSONArray();</span><br><span class="line">            <span class="keyword">for</span> (BeaconDto beacon:BeaconService.beaconList) &#123;</span><br><span class="line">                value.put(beacon.toJSON());</span><br><span class="line">            &#125;</span><br><span class="line">            callbackContext.success(value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            callbackContext.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 确认蓝牙可用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">verifyBluetooth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> access = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!BeaconManager.getInstanceForApplication(cordova.getActivity()).checkAvailability()) &#123;</span><br><span class="line">                <span class="keyword">final</span> AlertDialog.Builder builder = <span class="keyword">new</span> AlertDialog.Builder(cordova.getContext());</span><br><span class="line">                builder.setTitle(<span class="string">"蓝牙没有打开"</span>);</span><br><span class="line">                builder.setMessage(<span class="string">"请在设置中打开蓝牙，然后重启APP"</span>);</span><br><span class="line">                builder.setPositiveButton(android.R.string.ok, <span class="keyword">null</span>);</span><br><span class="line">                builder.setOnDismissListener(<span class="keyword">new</span> DialogInterface.OnDismissListener() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDismiss</span><span class="params">(DialogInterface dialog)</span> </span>&#123;</span><br><span class="line">                        cordova.getActivity().finishAffinity();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                builder.show();</span><br><span class="line">                access = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            <span class="keyword">final</span> AlertDialog.Builder builder = <span class="keyword">new</span> AlertDialog.Builder(cordova.getContext());</span><br><span class="line">            builder.setTitle(<span class="string">"低功耗蓝牙不可用"</span>);</span><br><span class="line">            builder.setMessage(<span class="string">"您的设备不支持低功耗蓝牙，请更换设备"</span>);</span><br><span class="line">            builder.setPositiveButton(android.R.string.ok, <span class="keyword">null</span>);</span><br><span class="line">            builder.setOnDismissListener(<span class="keyword">new</span> DialogInterface.OnDismissListener() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDismiss</span><span class="params">(DialogInterface dialog)</span> </span>&#123;</span><br><span class="line">                    cordova.getActivity().finishAffinity();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;);</span><br><span class="line">            builder.show();</span><br><span class="line">            access = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>  access;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在WebApp里面不断获取数据就行了</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取Beacon设备</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getBeacons</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (cordova &amp;&amp; cordova.plugins &amp;&amp; cordova.plugins.Beacon)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (cordova.plugins.Beacon.getBeacons) &#123;</span><br><span class="line">            cordova.plugins.Beacon.getBeacons(<span class="function"><span class="keyword">function</span>(<span class="params">beacons</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">var</span> sortBeacons = beacons.sort(<span class="function"><span class="keyword">function</span>(<span class="params">a,b</span>)</span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> b.rssi - a.rssi;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="keyword">if</span> (sortBeacons.length &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">                    setHumanLocation(sortBeacons);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="通过Beacon数据定位"><a href="#通过Beacon数据定位" class="headerlink" title="通过Beacon数据定位"></a>通过Beacon数据定位</h2><p>在说这一步的原理之前，得先引入一个下面会用到的数据：MeasuredPower，是指在信标1m处测得的信号强度，这一点一般出厂的时候会有相应的参数，当然也可以自己去矫正。那么手机获取数据时得到的信号强度，减去这个MeasuredPower，就是信号衰减量了。理论上来说，信号衰减量是随着距离的增加而增加的，具体关系可以去查论文，我查出来的有说信号强度跟距离的平方成反比的，也有说距离=kln(信号强度/MeasuredPower)的，K是衰减系数。</p>
<p>其实这都不重要，一来因为这个信号强度他不是一个稳定值，而且变动还挺大，可能拿着手机的人一个转身，就会有剧烈波动；二来因为基站会8到10米布置一个，完全不考虑信号强度只选最强信号也可以让误差在10米以内了，再考虑信号强度，三点定位，只要计算中贯彻距离越远衰减越强的策略，这个定位精度就会提高不少。考虑到信号波动，就算真的精准计算也不会比简单策略高到哪里去。其实最主要的是精准算距离之后的三角定位算法写起来挺麻烦的，我懒得折腾。</p>
<p>我就假设了信号衰减跟距离是完全的正比关系，如图假设三个点的信号衰减是d1,d2,d3，那在他们的三边上就能找出三个点，与他们的信号衰减量是成比例的，然后用这三点构成一个三角形，这个三角形的质心到黑色三角形三个顶点的距离比，就跟接收到这三个基站的信号衰减量的比一致了，所以定位点就选择选择蓝色三角形的质心。</p>
<p>这个算法肯定是有问题的，比如如果人跑到黑色三角形的外面，他还是有可能接收到这三个基站的信号，这个时候人毫无疑问不可能在蓝色三角形的质心。使用这个算法只因为有两个条件，第一是基站部署的足够密集，第二是精度要求没有很高且蓝牙信号强度波动本就比较大。</p>
<p><img src="http://qiniu.myshuju.net/blog/images/2021/beacon.png" alt="示意图"></p>
<p>代码如下，使用了<a href="http://turfjs.org/" target="_blank" rel="noopener">turf</a>进行距离、线上的点和三角形质心的计算。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置人的位置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>beacons </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns </span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setHumanLocation</span>(<span class="params">beacons</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> triangle = _scene.getMeshByID(<span class="string">'station_triangle'</span>);</span><br><span class="line">    <span class="keyword">if</span> (triangle) &#123;</span><br><span class="line">        _scene.removeMesh(triangle,<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> beacon1 = beacons[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">const</span> beacon2 = beacons[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">const</span> beacon3 = beacons[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span> (!_stationMap) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> station1 = _stationMap[beacon1.uuid.toUpperCase()];</span><br><span class="line">    <span class="keyword">const</span> station2 = _stationMap[beacon2.uuid.toUpperCase()];</span><br><span class="line">    <span class="keyword">const</span> station3 = _stationMap[beacon3.uuid.toUpperCase()];</span><br><span class="line">    <span class="keyword">if</span> (!station1 || !station2 || !station3) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'基站信息未获取'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> station1Postion = calRelativePosition(station1.position.x,station1.position.y);</span><br><span class="line">    <span class="keyword">const</span> station2Postion = calRelativePosition(station2.position.x,station2.position.y);</span><br><span class="line">    <span class="keyword">const</span> station3Postion = calRelativePosition(station3.position.x,station3.position.y);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> triangleHeight = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (_selectedFloor) &#123;</span><br><span class="line">        triangleHeight = _selectedFloor.height + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> positons = [</span><br><span class="line">        <span class="keyword">new</span> BABYLON.Vector3(station1Postion[<span class="number">0</span>], triangleHeight, station1Postion[<span class="number">1</span>]),</span><br><span class="line">        <span class="keyword">new</span> BABYLON.Vector3(station2Postion[<span class="number">0</span>], triangleHeight, station2Postion[<span class="number">1</span>]),</span><br><span class="line">        <span class="keyword">new</span> BABYLON.Vector3(station3Postion[<span class="number">0</span>], triangleHeight, station3Postion[<span class="number">1</span>]),</span><br><span class="line">        <span class="keyword">new</span> BABYLON.Vector3(station1Postion[<span class="number">0</span>], triangleHeight, station1Postion[<span class="number">1</span>]),</span><br><span class="line">    ]</span><br><span class="line">    <span class="comment">//显示信号最强的三个基站形成的三角形</span></span><br><span class="line">    <span class="keyword">const</span> stationTriangle = BABYLON.MeshBuilder.CreateLines(<span class="string">'station_triangle'</span>, &#123;<span class="attr">points</span>: positons&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//信号衰减量</span></span><br><span class="line">    <span class="keyword">let</span> decay1 =  station1.measuredPower - beacon1.rssi;</span><br><span class="line">    <span class="keyword">let</span> decay2 =  station2.measuredPower - beacon2.rssi;</span><br><span class="line">    <span class="keyword">let</span> decay3 =  station3.measuredPower - beacon3.rssi;</span><br><span class="line">    decay1 = decay1&gt;<span class="number">0</span>?decay1:<span class="number">1</span>;</span><br><span class="line">    decay2 = decay2&gt;<span class="number">0</span>?decay2:<span class="number">1</span>;</span><br><span class="line">    decay3 = decay3&gt;<span class="number">0</span>?decay3:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> distanceOption = &#123;<span class="attr">units</span>: <span class="string">'kilometers'</span>&#125;;</span><br><span class="line">    <span class="keyword">const</span> length12 = turf.distance(turf.point(station1Postion),turf.point(station2Postion),distanceOption);</span><br><span class="line">    <span class="keyword">const</span> length23 = turf.distance(turf.point(station2Postion),turf.point(station3Postion),distanceOption);</span><br><span class="line">    <span class="keyword">const</span> length13 = turf.distance(turf.point(station1Postion),turf.point(station3Postion),distanceOption);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> line12 = turf.lineString([station1Postion,station2Postion]);</span><br><span class="line">    <span class="keyword">const</span> line23 = turf.lineString([station2Postion,station3Postion]);</span><br><span class="line">    <span class="keyword">const</span> line13 = turf.lineString([station1Postion,station3Postion]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> point12 = turf.along(line12, length12 * decay1/(decay1 + decay2), distanceOption);</span><br><span class="line">    <span class="keyword">const</span> point23 = turf.along(line23, length23 * decay2/(decay2 + decay3), distanceOption);</span><br><span class="line">    <span class="keyword">const</span> point13 = turf.along(line13, length13 * decay1/(decay1 + decay3), distanceOption);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> features = turf.polygon([</span><br><span class="line">        [</span><br><span class="line">            point12.geometry.coordinates,</span><br><span class="line">            point23.geometry.coordinates,</span><br><span class="line">            point13.geometry.coordinates,</span><br><span class="line">            point12.geometry.coordinates]</span><br><span class="line">    ]);</span><br><span class="line">    <span class="keyword">const</span> center = turf.centerOfMass(features);</span><br><span class="line">    <span class="keyword">const</span> centerX = center.geometry.coordinates[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">const</span> centerY = center.geometry.coordinates[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = _scene.getMeshByID(<span class="string">'__human__'</span>);</span><br><span class="line">    <span class="keyword">if</span> (mesh) &#123;</span><br><span class="line">        <span class="keyword">let</span> height = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (_selectedFloor) &#123;</span><br><span class="line">            height = _selectedFloor.height + <span class="number">0.24</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mesh.position = <span class="keyword">new</span> BABYLON.Vector3(centerX, height, centerY);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h2><p><img src="http://qiniu.myshuju.net/blog/images/2021/114007_634df9c4_519952.webp" alt="效果图"></p>

        </section>
    </article>
    
        <!-- disqus 评论框 start -->
        <div class="comment">
            <div id="disqus_thread" class="disqus-thread">
              <i>加载评论框需要翻墙</i>
            </div>
        </div>
        <!-- disqus 评论框 end -->
    
    
        <!-- livere 评论框 start -->
        <div class="comment">
            <div id="lv-container" data-id="city" data-uid="your_livere_uid"></div>
        </div>
        <!-- livere 评论框 end -->
        
  </div>
  <aside>
    
    <div class="toc-container">
        <h1>目录</h1>
        <div class="content">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#数据生产"><span class="toc-number">1.</span> <span class="toc-text">数据生产</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#楼栋白模"><span class="toc-number">1.1.</span> <span class="toc-text">楼栋白模</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#楼层模型"><span class="toc-number">1.2.</span> <span class="toc-text">楼层模型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#管理后台展示模型"><span class="toc-number">2.</span> <span class="toc-text">管理后台展示模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#移动端展示模型"><span class="toc-number">3.</span> <span class="toc-text">移动端展示模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Beacon设备的组织"><span class="toc-number">4.</span> <span class="toc-text">Beacon设备的组织</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Beacon数据获取（Android）"><span class="toc-number">5.</span> <span class="toc-text">Beacon数据获取（Android）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WebApp获取Beacon数据"><span class="toc-number">6.</span> <span class="toc-text">WebApp获取Beacon数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通过Beacon数据定位"><span class="toc-number">7.</span> <span class="toc-text">通过Beacon数据定位</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#效果图"><span class="toc-number">8.</span> <span class="toc-text">效果图</span></a></li></ol>
        </div>
    </div>
    
  </aside>
</main>

<!-- disqus 公共JS代码 -->
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES * * */
  var disqus_shortname = "zxhm";
  var disqus_identifier = "http://zxhm.me/2021/2021/蓝牙Beacon室内定位全栈/";
  var disqus_url = "http://zxhm.me/2021/2021/蓝牙Beacon室内定位全栈/";

  isAgent(getDisqus)

  // determine user agent in China
  function isAgent(cb) {
    var url = '//graph.facebook.com/feed?callback=h';
    var xhr = new XMLHttpRequest();
    var called = false;
    xhr.open('GET', url);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4 && xhr.status === 200) {
      called = true;
      cb(true);
      }
    };
    xhr.send();
    // timeout 1s, this facebook API is very fast.
    setTimeout(function() {
      if (!called) {
      xhr.abort();
      cb(false)
      }
    }, 1000);
  }

  function getDisqus(isAgent) {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; 
    dsq.async = true
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq)
  }
</script>
<!-- disqus 公共JS代码 end -->


<script type="text/javascript">
  (function(d, s) {
      var j, e = d.getElementsByTagName(s)[0];

      if (typeof LivereTower === 'function') { return; }

      j = d.createElement(s);
      j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
      j.async = true;

      e.parentNode.insertBefore(j, e);
  })(document, 'script');
</script>


  <footer>
  <div class="copyright">
    <div>
      &copy; 2023 | Powered by <a href="https://www.myshuju.net" target="_blank">Andy Zhang</a>&nbsp
    </div>
    <!-- <div>
      Write by <a href="http://www.zxhm.me" target="_blank">Zxhm</a>
    </div> -->
  </div>
</footer>


<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="/lib/in-view.min.js"></script>
<script src="/lib/lodash.min.js"></script>
<script>
  var isDown = true
  var oldY = 0
  inView.offset(50)

  document.body.addEventListener('touchstart', function(){});
  
  window.addEventListener('scroll', _.throttle(e => {
    var currentY = window.scrollY
    if((oldY - currentY) < 0) {
      isDown = true
    } else {
      isDown = false
    }
    oldY = currentY
  }, 250))

  $("article img").each(function() {
      var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
      $(this).wrapAll(strA);
  });

  $('.toc-link').each(function() {
      var href = $(this).attr("href");
      
      inView(href).on('exit', () => {
        if (isDown) {
          handleActive(href)
        }
      })

      inView(href).on('enter', () => {
        if (!isDown) {
          handleActive(href)
        }
      })

      this.onclick = function(e) {
        var pos = $(href).offset().top - 10;
        $("html,body").animate({scrollTop: pos}, 300);
        setTimeout(() => {
          handleActive(href)
        }, 350)
        return false
      }
  })

  function handleActive(href) {
    document.querySelectorAll('.toc-link').forEach(elm => {
      elm.classList.remove('active')
    })
    document.querySelector(".toc [href='"+ href +"']").classList.add('active')
  }
</script>
<script src="/lib/jquery.fancybox.min.js"></script>


</body>
</html>
